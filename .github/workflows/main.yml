# .github/workflows/complete-testing.yml
# ğŸš€ Workflow GitHub Actions - Tests Professionnels Complets
# StratÃ©gie Ã©prouvÃ©e pour tests unitaires, intÃ©gration, performance, e2e et charge

name: ğŸ§ª Tests Complets - CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Tests nocturnes Ã  2h UTC pour la surveillance continue
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Niveau de tests Ã  exÃ©cuter'
        required: true
        default: 'all'
        type: choice
        options:
          - unit
          - integration
          - performance
          - e2e
          - security
          - all

# Variables d'environnement globales
env:
  NODE_ENV: test
  CI: true
  FORCE_COLOR: 3
  # Optimisations de performance
  NPM_CONFIG_PROGRESS: false
  NPM_CONFIG_AUDIT: false

# Permissions sÃ©curisÃ©es nÃ©cessaires
permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write
  actions: read

# Annulation des exÃ©cutions concurrentes pour Ã©conomiser les ressources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # ğŸ—ï¸ JOB PRÃ‰PARATOIRE - VALIDATION DU CODE
  # ============================================================================
  code-quality:
    name: ğŸ—ï¸ QualitÃ© du Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Historique complet pour SonarQube
      
      - name: ğŸ“¦ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: âš¡ Installation optimisÃ©e
        run: |
          npm ci --prefer-offline --no-audit --no-progress
          npm ls # VÃ©rification des dÃ©pendances
      
      - name: ğŸ” Lint & Format Check
        run: |
          npm run lint
          npm run format:check
          npm run type-check
      
      - name: ğŸ—ï¸ Build de validation
        run: npm run build
      
      - name: ğŸ“Š Upload artefacts build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            build/
          retention-days: 1

  # ============================================================================
  # ğŸ§ª TESTS UNITAIRES - RAPIDES ET FIABLES
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        node-version: [18, 20, 22]
        
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configuration Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¥ RÃ©cupÃ©ration build
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: âš¡ Installation
        run: npm ci --prefer-offline
      
      - name: ğŸ§ª ExÃ©cution tests unitaires
        run: |
          npm run test:unit -- \
            --verbose \
            --ci \
            --coverage \
            --watchAll=false \
            --maxWorkers=2 \
            --testResultsProcessor=jest-junit \
            --coverageReporters=text-lcov,lcov,json,cobertura
        env:
          JEST_JUNIT_OUTPUT_DIR: ./test-results
          JEST_JUNIT_OUTPUT_NAME: junit.xml
      
      - name: ğŸ“Š Upload rÃ©sultats tests
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-node-${{ matrix.node-version }}
          path: |
            test-results/
            coverage/
          retention-days: 30
      
      - name: ğŸ“ˆ Upload vers Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unit-tests,node-${{ matrix.node-version }}
          name: unit-tests-node-${{ matrix.node-version }}

  # ============================================================================
  # ğŸ”— TESTS D'INTÃ‰GRATION - SERVICES RÃ‰ELS
  # ============================================================================
  integration-tests:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 30
    if: github.event.inputs.test_level == 'integration' || github.event.inputs.test_level == 'all' || github.event.inputs.test_level == ''
    
    services:
      # Redis pour le cache et sessions
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 6379:6379
      
      # PostgreSQL pour les donnÃ©es
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: âš¡ Installation
        run: npm ci --prefer-offline
      
      - name: ğŸ—„ï¸ PrÃ©paration base de donnÃ©es
        run: |
          npm run db:migrate
          npm run db:seed:test
        env:
          DATABASE_URL: postgresql://testuser:testpass123@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379
      
      - name: ğŸ”— Tests d'intÃ©gration
        run: |
          npm run test:integration -- \
            --verbose \
            --ci \
            --coverage \
            --testTimeout=30000
        env:
          DATABASE_URL: postgresql://testuser:testpass123@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
      
      - name: ğŸ“Š Upload rÃ©sultats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/
            logs/
          retention-days: 30

  # ============================================================================
  # âš¡ TESTS DE PERFORMANCE - K6 + OPTIMISATIONS
  # ============================================================================
  performance-tests:
    name: âš¡ Tests de Performance
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 45
    if: github.ref == 'refs/heads/main' || github.event.inputs.test_level == 'performance' || github.event.inputs.test_level == 'all'
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: âš¡ Installation
        run: npm ci --prefer-offline
      
      - name: ğŸ—ï¸ Build optimisÃ©
        run: npm run build:prod
      
      - name: ğŸ“¥ Installation K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: ğŸš€ DÃ©marrage application
        run: |
          npm run start:prod &
          # Attendre la disponibilitÃ© de l'API
          timeout 60s bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'
          echo "âœ… Application dÃ©marrÃ©e"
        env:
          NODE_ENV: production
          REDIS_URL: redis://localhost:6379
          PORT: 3000
      
      - name: âš¡ Tests de charge - API Core
        run: |
          k6 run --out json=api-core-results.json tests/performance/api-core.js
          k6 run --out influxdb=http://localhost:8086/k6 tests/performance/api-core.js || true
        env:
          BASE_URL: http://localhost:3000
          VUS: 50
          DURATION: 5m
      
      - name: âš¡ Tests de charge - Authentification
        run: |
          k6 run --out json=auth-load-results.json tests/performance/auth-load.js
        env:
          BASE_URL: http://localhost:3000
          VUS: 30
          DURATION: 3m
      
      - name: âš¡ Tests de stress
        run: |
          k6 run --out json=stress-results.json tests/performance/stress-test.js
        env:
          BASE_URL: http://localhost:3000
      
      - name: ğŸ“Š Analyse des rÃ©sultats
        run: |
          echo "## ğŸ“Š RÃ©sultats des Tests de Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analyse API Core
          if [ -f api-core-results.json ]; then
            echo "### ğŸš€ API Core Performance" >> $GITHUB_STEP_SUMMARY
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('api-core-results.json', 'utf8'));
              const metrics = data.metrics;
              console.log('| MÃ©trique | Valeur |');
              console.log('|----------|---------|');
              console.log(\`| RequÃªtes totales | \${metrics.http_reqs.count} |\`);
              console.log(\`| RPS moyen | \${metrics.http_reqs.rate.toFixed(2)} |\`);
              console.log(\`| DurÃ©e moyenne | \${metrics.http_req_duration.avg.toFixed(2)}ms |\`);
              console.log(\`| P95 | \${metrics.http_req_duration['p(95)'].toFixed(2)}ms |\`);
              console.log(\`| P99 | \${metrics.http_req_duration['p(99)'].toFixed(2)}ms |\`);
              console.log(\`| Taux d'erreur | \${(metrics.http_req_failed.rate * 100).toFixed(2)}% |\`);
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: âš ï¸ Validation des seuils de performance
        run: |
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('api-core-results.json', 'utf8'));
            const metrics = data.metrics;
            
            const thresholds = {
              'P95 < 500ms': metrics.http_req_duration['p(95)'] < 500,
              'Error Rate < 1%': metrics.http_req_failed.rate < 0.01,
              'RPS > 100': metrics.http_reqs.rate > 100
            };
            
            let failed = false;
            for (const [check, passed] of Object.entries(thresholds)) {
              console.log(\`\${passed ? 'âœ…' : 'âŒ'} \${check}\`);
              if (!passed) failed = true;
            }
            
            if (failed) {
              console.error('âŒ Certains seuils de performance ne sont pas respectÃ©s');
              process.exit(1);
            }
          "
      
      - name: ğŸ“‹ Upload rÃ©sultats K6
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: |
            *-results.json
            k6-report.html
          retention-days: 30

  # ============================================================================
  # ğŸŒ TESTS END-TO-END - PARCOURS UTILISATEUR COMPLETS
  # ============================================================================
  e2e-tests:
    name: ğŸŒ Tests End-to-End
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 60
    if: github.event.inputs.test_level == 'e2e' || github.event.inputs.test_level == 'all' || github.event.inputs.test_level == ''
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: âš¡ Installation
        run: npm ci --prefer-offline
      
      - name: ğŸ­ Installation Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
      
      - name: ğŸš€ DÃ©marrage services
        run: |
          # DÃ©marrer l'API backend
          npm run start &
          
          # DÃ©marrer le frontend (si applicable)
          npm run start:frontend &
          
          # Attendre que les services soient prÃªts
          timeout 60s bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'
          timeout 60s bash -c 'until curl -f http://localhost:3001; do sleep 2; done' || true
        env:
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379
      
      - name: ğŸŒ ExÃ©cution tests E2E - ${{ matrix.browser }}
        run: |
          npx playwright test --project=${{ matrix.browser }} \
            --reporter=html,junit \
            --output-dir=test-results-${{ matrix.browser }}
        env:
          BASE_URL: http://localhost:3001
          API_URL: http://localhost:3000
          BROWSER: ${{ matrix.browser }}
      
      - name: ğŸ“Š Upload rÃ©sultats E2E
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: |
            test-results-${{ matrix.browser }}/
            playwright-report/
          retention-days: 30
      
      - name: ğŸ“¹ Upload vidÃ©os des tests
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-videos-${{ matrix.browser }}
          path: test-results-${{ matrix.browser }}/videos/
          retention-days: 7

  # ============================================================================
  # ğŸ›¡ï¸ TESTS DE SÃ‰CURITÃ‰ - ANALYSE COMPLÃˆTE
  # ============================================================================
  security-tests:
    name: ğŸ›¡ï¸ Tests de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.event.inputs.test_level == 'security' || github.event.inputs.test_level == 'all'
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: âš¡ Installation
        run: npm ci --prefer-offline
      
      - name: ğŸ›¡ï¸ Audit des dÃ©pendances npm
        run: |
          npm audit --audit-level=moderate
          npm audit --json > npm-audit-results.json || true
      
      - name: ğŸ” Analyse CodeQL - Initialisation
        uses: github/codeql-action/init@v3
        with:
          languages: typescript, javascript
          queries: security-and-quality
      
      - name: ğŸ—ï¸ Build pour analyse
        run: npm run build
      
      - name: ğŸ” Analyse CodeQL - ExÃ©cution
        uses: github/codeql-action/analyze@v3
        with:
          category: security-analysis
      
      - name: ğŸ•·ï¸ Scan Snyk (si token disponible)
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json > snyk-results.json
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ Tests de sÃ©curitÃ© personnalisÃ©s
        run: |
          npm run test:security || true
          npm run security:scan || true
        continue-on-error: true
      
      - name: ğŸ“Š Upload rÃ©sultats sÃ©curitÃ©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: |
            npm-audit-results.json
            snyk-results.json
            security-scan-report.html
          retention-days: 30

  # ============================================================================
  # ğŸ“Š CONSOLIDATION DES RÃ‰SULTATS
  # ============================================================================
  test-summary:
    name: ğŸ“Š RÃ©sumÃ© des Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, e2e-tests, security-tests]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration de tous les artefacts
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: ğŸ“Š GÃ©nÃ©ration du rapport consolidÃ©
        run: |
          cat > test-summary.md << 'EOF'
          # ğŸ¯ Rapport ConsolidÃ© des Tests
          
          **Commit**: `${{ github.sha }}`
          **Branche**: `${{ github.ref_name }}`
          **Workflow**: `${{ github.workflow }}`
          **DÃ©clenchÃ© par**: ${{ github.event_name }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## ğŸ“ˆ RÃ©sultats par CatÃ©gorie
          
          | Type de Test | Statut | DurÃ©e |
          |--------------|--------|-------|
          | ğŸ§ª Tests Unitaires | ${{ needs.unit-tests.result == 'success' && 'âœ… RÃ©ussi' || needs.unit-tests.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }} | ${{ needs.unit-tests.result != 'skipped' && 'X minutes' || '-' }} |
          | ğŸ”— Tests d'IntÃ©gration | ${{ needs.integration-tests.result == 'success' && 'âœ… RÃ©ussi' || needs.integration-tests.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }} | ${{ needs.integration-tests.result != 'skipped' && 'X minutes' || '-' }} |
          | âš¡ Tests de Performance | ${{ needs.performance-tests.result == 'success' && 'âœ… RÃ©ussi' || needs.performance-tests.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }} | ${{ needs.performance-tests.result != 'skipped' && 'X minutes' || '-' }} |
          | ğŸŒ Tests E2E | ${{ needs.e2e-tests.result == 'success' && 'âœ… RÃ©ussi' || needs.e2e-tests.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }} | ${{ needs.e2e-tests.result != 'skipped' && 'X minutes' || '-' }} |
          | ğŸ›¡ï¸ Tests de SÃ©curitÃ© | ${{ needs.security-tests.result == 'success' && 'âœ… RÃ©ussi' || needs.security-tests.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }} | ${{ needs.security-tests.result != 'skipped' && 'X minutes' || '-' }} |
          
          ## ğŸ¯ Indicateurs ClÃ©s
          
          - **Couverture de Code**: Disponible dans les artefacts
          - **Performance P95**: VÃ©rifier les rÃ©sultats K6
          - **VulnÃ©rabilitÃ©s**: Consulter les rapports de sÃ©curitÃ©
          - **Tests E2E**: VidÃ©os disponibles en cas d'Ã©chec
          
          ## ğŸ“‹ Actions RecommandÃ©es
          
          EOF
          
          # Ajouter des recommandations basÃ©es sur les rÃ©sultats
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "- âŒ **Corriger les tests unitaires Ã©chouÃ©s**" >> test-summary.md
          fi
          
          if [[ "${{ needs.security-tests.result }}" != "success" && "${{ needs.security-tests.result }}" != "skipped" ]]; then
            echo "- ğŸ›¡ï¸ **Examiner les problÃ¨mes de sÃ©curitÃ© dÃ©tectÃ©s**" >> test-summary.md
          fi
          
          if [[ "${{ needs.performance-tests.result }}" != "success" && "${{ needs.performance-tests.result }}" != "skipped" ]]; then
            echo "- âš¡ **Optimiser les performances selon les mÃ©triques K6**" >> test-summary.md
          fi
          
          echo "" >> test-summary.md
          echo "---" >> test-summary.md
          echo "*Rapport gÃ©nÃ©rÃ© automatiquement par GitHub Actions*" >> test-summary.md
      
      - name: ğŸ“Š Ajout au rÃ©sumÃ© du workflow
        run: |
          cat test-summary.md >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“‹ Upload rapport final
        uses: actions/upload-artifact@v4
        with:
          name: final-test-report
          path: test-summary.md
          retention-days: 90
      
      - name: ğŸ”” Notification en cas d'Ã©chec critique
        if: needs.unit-tests.result == 'failure' || needs.security-tests.result == 'failure'
        run: |
          echo "::error::Tests critiques Ã©chouÃ©s. Intervention requise."
          exit 1

  # ============================================================================
  # ğŸš€ DÃ‰PLOIEMENT CONDITIONNEL (SI TOUS LES TESTS PASSENT)
  # ============================================================================
  deploy-staging:
    name: ğŸš€ DÃ©ploiement Staging
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests]
    if: github.ref == 'refs/heads/develop' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.security-tests.result == 'success'
    environment: staging
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4
      
      - name: ğŸš€ DÃ©ploiement vers staging
        run: |
          echo "ğŸš€ DÃ©ploiement vers l'environnement de staging..."
          # Ajouter ici vos commandes de dÃ©ploiement
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"